<ion-header [translucent]="true" class="custom-header">
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Rutina del Cliente</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="main-content">
  
  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando...</p>
  </div>

  <div *ngIf="!loading" class="content-wrapper">
    
    <!-- Información del cliente -->
    <ion-card class="cliente-info-card" *ngIf="cliente">
      <ion-card-header>
        <ion-card-title style="color: var(--primary-green);">
          <ion-icon name="person-circle-outline"></ion-icon>
          {{ cliente.nombre }} {{ cliente.apellido }}
        </ion-card-title>
        <ion-card-subtitle>
          <ion-icon name="mail-outline"></ion-icon>
          {{ cliente.correo }}
        </ion-card-subtitle>
      </ion-card-header>
    </ion-card>

    <!-- Sin rutinas asignadas -->
    <div *ngIf="rutinasAsignadas.length === 0" style="text-align: center; padding: 40px;">
      <ion-icon name="calendar-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
      <p style="color: var(--ion-color-medium);">No hay rutinas asignadas</p>
      <ion-button (click)="asignarNuevaRutina()" color="success">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Asignar Rutina
      </ion-button>
    </div>

    <!-- Rutinas asignadas por día -->
    <div *ngFor="let rutinaAsignada of rutinasAsignadas">
      <ion-card class="rutina-card">
        <ion-card-header>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <!-- Día de la semana -->
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <ion-chip color="primary" style="font-weight: bold;">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <ion-label>{{ diasSemana[rutinaAsignada.dia_semana] || 'Día ' + rutinaAsignada.dia_semana }}</ion-label>
                </ion-chip>
                <ion-chip [color]="rutinaAsignada.estado === 'en_progreso' ? 'success' : rutinaAsignada.estado === 'completada' ? 'primary' : 'medium'">
                  <ion-label style="text-transform: capitalize;">{{ rutinaAsignada.estado?.replace('_', ' ') || 'Pendiente' }}</ion-label>
                </ion-chip>
              </div>
              
              <ion-card-title style="color: var(--primary-green);">
                <ion-icon name="barbell-outline"></ion-icon>
                {{ rutinaAsignada.rutina?.nombre }}
              </ion-card-title>
              <ion-card-subtitle>
                <ion-chip [color]="rutinaAsignada.rutina?.nivel_dificultad === 'principiante' ? 'success' : rutinaAsignada.rutina?.nivel_dificultad === 'intermedio' ? 'warning' : 'danger'" size="small">
                  {{ getNivelLabel(rutinaAsignada.rutina?.nivel_dificultad) }}
                </ion-chip>
              </ion-card-subtitle>
            </div>
            
            <!-- Botón para eliminar rutina -->
            <ion-button fill="clear" color="danger" (click)="eliminarRutinaAsignada(rutinaAsignada)">
              <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-card-header>

        <ion-card-content>
          <!-- Descripción y objetivo -->
          <div *ngIf="rutinaAsignada.rutina?.descripcion" style="margin-bottom: 15px;">
            <strong style="color: var(--primary-green);">Descripción:</strong>
            <p style="color: var(--ion-color-medium); margin: 5px 0;">{{ rutinaAsignada.rutina.descripcion }}</p>
          </div>

          <div *ngIf="rutinaAsignada.rutina?.objetivo" style="margin-bottom: 15px;">
            <strong style="color: var(--primary-green);">Objetivo:</strong>
            <p style="color: var(--ion-color-medium); margin: 5px 0;">{{ rutinaAsignada.rutina.objetivo }}</p>
          </div>

          <!-- Fechas -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
            <div style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 8px;">
              <small style="color: var(--ion-color-medium);">Fecha de inicio</small>
              <div style="color: var(--primary-green); font-weight: bold;">
                {{ rutinaAsignada.fecha_inicio ? (rutinaAsignada.fecha_inicio | date: 'dd/MM/yyyy') : 'No especificada' }}
              </div>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 8px;">
              <small style="color: var(--ion-color-medium);">Fecha de fin</small>
              <div style="color: var(--primary-green); font-weight: bold;">
                {{ rutinaAsignada.fecha_fin ? (rutinaAsignada.fecha_fin | date: 'dd/MM/yyyy') : 'No especificada' }}
              </div>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 8px;">
              <small style="color: var(--ion-color-medium);">Duración</small>
              <div style="color: var(--primary-green); font-weight: bold;">
                {{ rutinaAsignada.rutina?.duracion_semanas || 0 }} semanas
              </div>
            </div>
          </div>

          <!-- Notas -->
          <div *ngIf="rutinaAsignada.notas" style="background: rgba(0, 255, 136, 0.05); padding: 12px; border-left: 3px solid var(--primary-green); border-radius: 4px; margin-bottom: 15px;">
            <strong style="color: var(--primary-green);">Notas del entrenador:</strong>
            <p style="color: var(--ion-color-medium); margin: 5px 0 0 0;">{{ rutinaAsignada.notas }}</p>
          </div>

          <!-- Ejercicios personalizados -->
          <div *ngIf="rutinaAsignada.ejercicios && rutinaAsignada.ejercicios.length > 0">
            <h3 style="color: var(--primary-green); margin: 15px 0 10px 0;">
              <ion-icon name="list-outline"></ion-icon>
              Ejercicios ({{ rutinaAsignada.ejercicios.length }})
            </h3>

            <div *ngFor="let ej of rutinaAsignada.ejercicios; let i = index" 
                 style="background: rgba(0, 255, 136, 0.05); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
              
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="background: var(--primary-green); color: #000000; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                  {{ i + 1 }}
                </div>
                <div style="flex: 1;">
                  <h3 style="color: var(--primary-green); margin: 0; font-size: 1.1rem;">
                    {{ ej.ejercicio?.nombre || 'Ejercicio sin nombre' }}
                  </h3>
                  <p style="color: var(--ion-color-medium); margin: 3px 0 0 0; font-size: 0.9rem;">
                    <ion-icon name="body-outline" style="vertical-align: middle;"></ion-icon>
                    {{ ej.ejercicio?.musculo_principal || 'N/A' }}
                  </p>
                </div>
                <!-- Botón para cambiar ejercicio -->
                <ion-button fill="clear" size="small" color="warning" (click)="cambiarEjercicio(rutinaAsignada, ej)">
                  <ion-icon name="swap-horizontal-outline" slot="icon-only"></ion-icon>
                </ion-button>
              </div>

              <!-- Parámetros -->
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                <div style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 6px; text-align: center;">
                  <small style="color: var(--ion-color-medium);">Series</small>
                  <div style="color: var(--primary-green); font-weight: bold; font-size: 1.1rem;">{{ ej.series || 'N/A' }}</div>
                </div>
                <div style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 6px; text-align: center;">
                  <small style="color: var(--ion-color-medium);">Reps</small>
                  <div style="color: var(--primary-green); font-weight: bold; font-size: 1.1rem;">{{ ej.repeticiones || 'N/A' }}</div>
                </div>
                <div style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 6px; text-align: center;">
                  <small style="color: var(--ion-color-medium);">Descanso</small>
                  <div style="color: var(--primary-green); font-weight: bold; font-size: 1.1rem;">{{ ej.descanso_segundos || 60 }}s</div>
                </div>
              </div>

              <!-- Video o GIF -->
              <div *ngIf="ej.ejercicio?.enlace_video" style="margin-top: 10px;">
                <ng-container *ngIf="isImageUrl(ej.ejercicio.enlace_video); else iframeBlock">
                  <img [src]="getDirectImageUrl(ej.ejercicio.enlace_video)" alt="Ejercicio" style="width:100%; height:auto; border-radius:8px; border:2px solid rgba(0,255,136,0.3);" />
                </ng-container>
                <ng-template #iframeBlock>
                  <ng-container *ngIf="isVideoUrl(ej.ejercicio.enlace_video); else legacyIframe">
                    <iframe [src]="getSafeUrl(getDirectVideoUrl(ej.ejercicio.enlace_video))" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen
                            style="width:100%; height:250px; border-radius:8px; border:2px solid rgba(0,255,136,0.3);">
                    </iframe>
                  </ng-container>
                  <ng-template #legacyIframe>
                    <iframe
                      [src]="getSafeUrl(ej.ejercicio.enlace_video)"
                      frameborder="0"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      allowfullscreen
                      style="width: 100%; height: 250px; border-radius: 8px; border: 2px solid rgba(0, 255, 136, 0.3);">
                    </iframe>
                  </ng-template>
                </ng-template>
              </div>

              <!-- Notas del ejercicio -->
              <div *ngIf="ej.notas" style="margin-top: 10px; padding: 10px; background: rgba(0, 255, 136, 0.08); border-left: 3px solid var(--primary-green); border-radius: 4px;">
                <small style="color: var(--ion-color-medium);">Nota:</small>
                <p style="margin: 3px 0 0 0; color: #ffffff;">{{ ej.notas }}</p>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

  </div>

</ion-content>

<!-- Modal para cambiar ejercicio -->
<ion-modal 
  [isOpen]="showModalCambiarEjercicio" 
  (didDismiss)="cerrarModalCambiarEjercicio()"
  [backdropDismiss]="true">
  <ng-template>
    <ion-header>
      <ion-toolbar color="dark">
        <ion-title>Seleccionar nuevo ejercicio</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalCambiarEjercicio()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
      <ion-toolbar>
        <ion-searchbar 
          [(ngModel)]="filtroEjercicio"
          (ionInput)="filtrarEjercicios()"
          placeholder="Buscar ejercicio..."
          debounce="300">
        </ion-searchbar>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div *ngIf="cargandoEjercicios" class="loading-container">
        <ion-spinner></ion-spinner>
        <p>Cargando ejercicios...</p>
      </div>

      <ion-list *ngIf="!cargandoEjercicios">
        <ion-item 
          button
          *ngFor="let ejercicio of ejerciciosDisponiblesFiltrados"
          (click)="seleccionarNuevoEjercicio(ejercicio)"
          [disabled]="ejercicio.id === ejercicioACambiar?.ejercicio_id">
          
          <ion-label>
            <h3>{{ ejercicio.nombre }}</h3>
            <p>{{ ejercicio.musculo_principal }}</p>
            <p *ngIf="ejercicio.categoria" class="categoria-text">{{ ejercicio.categoria }}</p>
          </ion-label>
          
          <ion-icon 
            *ngIf="ejercicio.id === ejercicioACambiar?.ejercicio_id"
            name="checkmark-circle"
            color="primary"
            slot="end">
          </ion-icon>
        </ion-item>

        <div *ngIf="ejerciciosDisponiblesFiltrados.length === 0" class="no-results">
          <ion-icon name="search-outline"></ion-icon>
          <p>No se encontraron ejercicios</p>
        </div>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
