<ion-header [translucent]="true" class="custom-header">
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Rutina del Cliente</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="main-content">

  <div *ngIf="!loading" class="content-wrapper">
    
    <!-- Información del cliente -->
    <ion-card class="cliente-info-card" *ngIf="cliente">
      <ion-card-header>
        <ion-card-title style="color: var(--primary-green);">
          <ion-icon name="person-circle-outline"></ion-icon>
          {{ cliente.nombre }} {{ cliente.apellido }}
        </ion-card-title>
        <ion-card-subtitle>
          <ion-icon name="mail-outline"></ion-icon>
          {{ cliente.correo }}
        </ion-card-subtitle>
      </ion-card-header>
    </ion-card>

    <!-- Sin rutinas asignadas -->
    <div *ngIf="rutinasAsignadas.length === 0" style="text-align: center; padding: 40px;">
      <ion-icon name="calendar-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
      <p style="color: var(--ion-color-medium);">No hay rutinas asignadas</p>
      <ion-button (click)="asignarNuevaRutina()" color="success">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Asignar Rutina
      </ion-button>
    </div>

    <!-- Filtro por días -->
    <div *ngIf="rutinasAsignadas.length > 0" style="margin-bottom: 20px;">
      <ion-segment [value]="diaSeleccionado.toString()" (ionChange)="cambiarDia($event)" scrollable="true" mode="md">
        <ion-segment-button value="0">
          <ion-label>Todos</ion-label>
        </ion-segment-button>
        <ion-segment-button *ngFor="let dia of diasDisponibles" [value]="dia.toString()">
          <ion-label>{{ diasSemana[dia] || 'Día ' + dia }}</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Botón para asignar nueva rutina -->
    <ion-button 
      *ngIf="rutinasAsignadas.length > 0 && rutinasAsignadas.length < 6"
      class="fab-button"
      (click)="asignarNuevaRutina()"
      expand="block"
      color="success">
      <ion-icon name="add-circle-outline" slot="start"></ion-icon>
      Asignar Nueva Rutina ({{ rutinasAsignadas.length }}/6)
    </ion-button>

    <!-- Mensaje cuando ya tiene 6 rutinas -->
    <div *ngIf="rutinasAsignadas.length >= 6" class="max-rutinas-message">
      <ion-icon name="checkmark-circle-outline"></ion-icon>
      <p>Este cliente ya tiene el máximo de rutinas asignadas (6 días)</p>
    </div>

    <!-- Rutinas asignadas por día -->
    <div *ngFor="let rutinaAsignada of rutinasAMostrar">
      <ion-card class="rutina-card">
        <ion-card-header>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <!-- Día de la semana -->
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <ion-chip color="primary" style="font-weight: bold;">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <ion-label>{{ diasSemana[rutinaAsignada.dia_semana] || 'Día ' + rutinaAsignada.dia_semana }}</ion-label>
                </ion-chip>
              </div>
              
              <ion-card-title style="color: var(--primary-green);">
                <ion-icon name="barbell-outline"></ion-icon>
                {{ rutinaAsignada.rutina?.nombre }}
              </ion-card-title>
              <ion-card-subtitle>
                <ion-chip [color]="rutinaAsignada.rutina?.nivel_dificultad === 'principiante' ? 'success' : rutinaAsignada.rutina?.nivel_dificultad === 'intermedio' ? 'warning' : 'danger'" size="small">
                  {{ getNivelLabel(rutinaAsignada.rutina?.nivel_dificultad) }}
                </ion-chip>
              </ion-card-subtitle>
            </div>
            
            <!-- Botón para eliminar rutina -->
            <ion-button fill="clear" color="danger" (click)="eliminarRutinaAsignada(rutinaAsignada)">
              <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-card-header>

        <ion-card-content>
          <!-- Descripción y objetivo -->
          <div *ngIf="rutinaAsignada.rutina?.descripcion" style="margin-bottom: 15px;">
            <strong style="color: var(--primary-green);">Descripción:</strong>
            <p style="color: var(--ion-color-medium); margin: 5px 0;">{{ rutinaAsignada.rutina.descripcion }}</p>
          </div>

          <div *ngIf="rutinaAsignada.rutina?.objetivo" style="margin-bottom: 15px;">
            <strong style="color: var(--primary-green);">Objetivo:</strong>
            <p style="color: var(--ion-color-medium); margin: 5px 0;">{{ rutinaAsignada.rutina.objetivo }}</p>
          </div>

          <!-- Fechas -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
            <div style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 8px;">
              <small style="color: var(--ion-color-medium);">Fecha de asignación</small>
              <div style="color: var(--primary-green); font-weight: bold;">
                {{ rutinaAsignada.fecha_asignacion ? (rutinaAsignada.fecha_asignacion | date: 'dd/MM/yyyy') : 'No especificada' }}
              </div>
            </div>
          </div>

          <!-- Notas -->
          <div *ngIf="rutinaAsignada.notas" style="background: rgba(0, 255, 136, 0.05); padding: 12px; border-left: 3px solid var(--primary-green); border-radius: 4px; margin-bottom: 15px;">
            <strong style="color: var(--primary-green);">Notas del entrenador:</strong>
            <p style="color: var(--ion-color-medium); margin: 5px 0 0 0;">{{ rutinaAsignada.notas }}</p>
          </div>

          <!-- Ejercicios personalizados en carrusel -->
          <div *ngIf="rutinaAsignada.ejercicios && rutinaAsignada.ejercicios.length > 0">
            <div class="ejercicios-header">
              <h3>
                <ion-icon name="barbell-outline"></ion-icon>
                Ejercicios
              </h3>
              <ion-chip color="success" class="contador-chip">
                <ion-label>{{ getCarouselIndex(rutinaAsignada) + 1 }}/{{ rutinaAsignada.ejercicios.length }}</ion-label>
              </ion-chip>
            </div>

            <!-- Carrusel de ejercicios con gestos -->
            <div class="ejercicios-carousel">
              <div class="carousel-wrapper"
                   (touchstart)="onTouchStart($event, rutinaAsignada)"
                   (touchmove)="onTouchMove($event, rutinaAsignada)"
                   (touchend)="onTouchEnd($event, rutinaAsignada)">
                <div class="carousel-track" 
                     [style.transform]="'translateX(' + getCarouselTransform(rutinaAsignada) + ')'"
                     [class.transitioning]="!isDragging(rutinaAsignada)">
                  <div class="ejercicio-slide" *ngFor="let ej of rutinaAsignada.ejercicios; let i = index">
                    <div class="ejercicio-card">
                      
                      <!-- Header compacto -->
                      <div class="card-header">
                        <div class="numero-badge">{{ i + 1 }}</div>
                        <div class="titulo-ejercicio">
                          <h4>{{ ej.ejercicio?.nombre || 'Ejercicio sin nombre' }}</h4>
                          <p><ion-icon name="body-outline"></ion-icon>{{ ej.ejercicio?.musculo_principal || 'N/A' }}</p>
                        </div>
                        <ion-button fill="clear" size="small" (click)="cambiarEjercicio(rutinaAsignada, ej)" class="btn-swap">
                          <ion-icon name="swap-horizontal-outline"></ion-icon>
                        </ion-button>
                      </div>

                      <!-- Parámetros compactos -->
                      <div class="parametros-row">
                        <div class="param-box">
                          <ion-icon name="repeat-outline"></ion-icon>
                          <span class="valor">{{ ej.series || 'N/A' }}</span>
                          <span class="label">SERIES</span>
                        </div>
                        <div class="param-box">
                          <ion-icon name="fitness-outline"></ion-icon>
                          <span class="valor">{{ ej.repeticiones || 'N/A' }}</span>
                          <span class="label">REPS</span>
                        </div>
                        <div class="param-box">
                          <ion-icon name="timer-outline"></ion-icon>
                          <span class="valor">{{ ej.descanso_segundos || 60 }}s</span>
                          <span class="label">DESCANSO</span>
                        </div>
                        <div class="param-box">
                          <ion-icon name="flash-outline"></ion-icon>
                          <span class="valor">{{ ej.porcentaje_fuerza || 100 }}%</span>
                          <span class="label">FUERZA</span>
                        </div>
                      </div>

                      <!-- Mini carrusel de videos (Principal / Alternativo) -->
                      <div class="video-carousel-mini" style="margin-top: 10px;">
                        <!-- Botones indicadores si hay alternativo -->
                        <div *ngIf="ej.ejercicio_alternativo" class="mini-indicators">
                          <span 
                            class="mini-indicator" 
                            [class.active]="getVideoCarouselIndex(rutinaAsignada, i) === 0"
                            (click)="setVideoCarouselIndex(rutinaAsignada, i, 0)">
                            Principal
                          </span>
                          <span 
                            class="mini-indicator" 
                            [class.active]="getVideoCarouselIndex(rutinaAsignada, i) === 1"
                            (click)="setVideoCarouselIndex(rutinaAsignada, i, 1)">
                            Alternativo
                          </span>
                        </div>

                        <!-- Video Principal -->
                        <div *ngIf="getVideoCarouselIndex(rutinaAsignada, i) === 0" class="video-slide-mini">
                          <div class="media-wrapper" *ngIf="ej.ejercicio?.enlace_video">
                            <ng-container *ngIf="isImageUrl(ej.ejercicio.enlace_video); else iframeBlockPrincipal">
                              <img [src]="getDirectImageUrl(ej.ejercicio.enlace_video)" alt="Ejercicio Principal" class="media-content" />
                            </ng-container>
                            <ng-template #iframeBlockPrincipal>
                              <ng-container *ngIf="isVideoUrl(ej.ejercicio.enlace_video); else legacyIframePrincipal">
                                <iframe [src]="getSafeUrl(getDirectVideoUrl(ej.ejercicio.enlace_video))" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen
                                        class="media-content">
                                </iframe>
                              </ng-container>
                              <ng-template #legacyIframePrincipal>
                                <iframe
                                  [src]="getSafeUrl(ej.ejercicio.enlace_video)"
                                  frameborder="0"
                                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                  allowfullscreen
                                  class="media-content">
                                </iframe>
                              </ng-template>
                            </ng-template>
                          </div>
                        </div>

                        <!-- Video Alternativo -->
                        <div *ngIf="ej.ejercicio_alternativo && getVideoCarouselIndex(rutinaAsignada, i) === 1" class="video-slide-mini">
                          <div class="media-wrapper" *ngIf="ej.ejercicio_alternativo.enlace_video">
                            <ng-container *ngIf="isImageUrl(ej.ejercicio_alternativo.enlace_video); else iframeBlockAlt">
                              <img [src]="getDirectImageUrl(ej.ejercicio_alternativo.enlace_video)" alt="Ejercicio Alternativo" class="media-content" />
                            </ng-container>
                            <ng-template #iframeBlockAlt>
                              <ng-container *ngIf="isVideoUrl(ej.ejercicio_alternativo.enlace_video); else legacyIframeAlt">
                                <iframe [src]="getSafeUrl(getDirectVideoUrl(ej.ejercicio_alternativo.enlace_video))" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen
                                        class="media-content">
                                </iframe>
                              </ng-container>
                              <ng-template #legacyIframeAlt>
                                <iframe
                                  [src]="getSafeUrl(ej.ejercicio_alternativo.enlace_video)"
                                  frameborder="0"
                                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                  allowfullscreen
                                  class="media-content">
                                </iframe>
                              </ng-template>
                            </ng-template>
                          </div>
                          
                          <!-- Info del ejercicio alternativo eliminado por solicitud del usuario -->
                        </div>
                      </div>

                      <!-- Notas -->
                      <div *ngIf="ej.notas" class="notas-box">
                        <ion-icon name="information-circle"></ion-icon>
                        <span>{{ ej.notas }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Indicadores -->
              <div class="carousel-dots" *ngIf="rutinaAsignada.ejercicios.length > 1">
                <span *ngFor="let ej of rutinaAsignada.ejercicios; let i = index" 
                      class="dot" 
                      [class.active]="i === getCarouselIndex(rutinaAsignada)"
                      (click)="irAEjercicio(rutinaAsignada, i)">
                </span>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

  </div>

  <!-- Spinner overlay -->
  <div *ngIf="mostrarSpinner" class="spinner-overlay-transparent">
    <app-spinner></app-spinner>
  </div>

</ion-content>
