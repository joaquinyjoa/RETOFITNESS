<ion-header [translucent]="true" class="custom-header">
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Entrenamientos</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="segmentValue === 'ejercicios'" (click)="abrirModal()">
        <ion-icon slot="start" name="add-circle-outline"></ion-icon>
        Agregar Ejercicio
      </ion-button>
      <ion-button *ngIf="segmentValue === 'rutinas'" (click)="abrirModalRutina()">
        <ion-icon slot="start" name="add-circle-outline"></ion-icon>
        Nueva Rutina
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Segment para cambiar entre Ejercicios y Rutinas -->
  <ion-toolbar color="dark" class="segment-toolbar">
    <ion-segment [(ngModel)]="segmentValue" (ionChange)="onSegmentChange($event)" mode="md">
      <ion-segment-button value="ejercicios">
        <ion-label>Ejercicios</ion-label>
      </ion-segment-button>
      <ion-segment-button value="rutinas">
        <ion-label>Rutinas</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="main-content">
  
  <!-- ============================================ -->
  <!-- TAB DE EJERCICIOS -->
  <!-- ============================================ -->
  <div *ngIf="segmentValue === 'ejercicios'">
    
    <!-- Filtros -->
    <div class="filters-section">
    <ion-searchbar 
      [(ngModel)]="filtroTexto" 
      (ionInput)="aplicarFiltros()"
      placeholder="Buscar ejercicios..."
      show-clear-button="focus">
    </ion-searchbar>

    <div class="filter-row">
      <ion-select 
        [(ngModel)]="filtroCategoria" 
        (ionChange)="aplicarFiltros()"
        placeholder="Categoría"
        interface="popover">
        <ion-select-option value="">Todas las categorías</ion-select-option>
        <ion-select-option *ngFor="let cat of categorias" [value]="cat.value">
          {{ cat.label }}
        </ion-select-option>
      </ion-select>

      <ion-select 
        [(ngModel)]="filtroMusculo" 
        (ionChange)="aplicarFiltros()"
        placeholder="Músculo"
        interface="popover">
        <ion-select-option value="">Todos los músculos</ion-select-option>
        <ion-select-option *ngFor="let musculo of gruposMusculares" [value]="musculo">
          {{ musculo }}
        </ion-select-option>
      </ion-select>

      <ion-button fill="clear" (click)="limpiarFiltros()">
        <ion-icon name="refresh"></ion-icon>
      </ion-button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando ejercicios...</p>
  </div>

  <!-- Lista de ejercicios -->
  <div *ngIf="!loading" class="exercises-grid">
    
    <!-- Sin ejercicios -->
    <div *ngIf="ejerciciosFiltrados.length === 0" class="no-exercises">
      <ion-icon name="barbell-outline" size="large"></ion-icon>
      <h3>No hay ejercicios</h3>
      <p *ngIf="filtroTexto || filtroCategoria || filtroMusculo">
        No se encontraron ejercicios con estos filtros
      </p>
      <p *ngIf="!filtroTexto && !filtroCategoria && !filtroMusculo">
        Aún no has agregado ejercicios
      </p>
      <ion-button fill="outline" (click)="abrirModal()">
        Agregar primer ejercicio
      </ion-button>
    </div>

    <!-- Tarjetas de ejercicios -->
    <ion-card *ngFor="let ejercicio of ejerciciosFiltrados; trackBy: trackByIndex" class="exercise-card">
      
      <!-- Header de la tarjeta -->
      <ion-card-header>
        <div class="card-header-content">
          <div class="exercise-info">
            <ion-card-title>{{ ejercicio.nombre }}</ion-card-title>
            <ion-card-subtitle>
              <div class="subtitle-row">
                <ion-badge [color]="getCategoriaColor(ejercicio.categoria)" class="category-badge">
                  {{ getCategoriaLabel(ejercicio.categoria) }}
                </ion-badge>
                <ion-badge color="medium" class="difficulty-badge">
                  {{ getNivelLabel(ejercicio.nivel_dificultad) }}
                </ion-badge>
              </div>
              <span class="muscle-group">
                <ion-icon name="body" size="small"></ion-icon>
                {{ ejercicio.musculo_principal }}
              </span>
            </ion-card-subtitle>
          </div>
          <div class="actions">
            <ion-button fill="clear" size="small" (click)="abrirModal(ejercicio)" class="action-btn edit-btn">
              Modificar
            </ion-button>
            <ion-button fill="clear" size="small" (click)="eliminarEjercicio(ejercicio)" class="action-btn delete-btn">
              <ion-icon name="trash"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-card-header>

      <!-- Contenido de la tarjeta -->
      <ion-card-content>
        <p *ngIf="ejercicio.descripcion" class="description">
          {{ ejercicio.descripcion }}
        </p>
        
        <div class="exercise-details">
          <div *ngIf="ejercicio.duracion_minutos" class="detail-item">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ ejercicio.duracion_minutos }} min</span>
          </div>

          <div *ngIf="ejercicio.equipamiento && ejercicio.equipamiento.length > 0" class="detail-item">
            <ion-icon name="barbell-outline"></ion-icon>
            <span>{{ getEquipamientoText(ejercicio.equipamiento) }}</span>
          </div>

          <!-- Mostrar video directamente en la tarjeta -->
          <div *ngIf="ejercicio.enlace_video" class="video-preview">
            <iframe 
              [src]="getVideoEmbedUrl(ejercicio.enlace_video)" 
              width="100%" 
              height="250" 
              frameborder="0" 
              allowfullscreen
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              class="video-frame">
            </iframe>
          </div>
        </div>

        <div *ngIf="ejercicio.musculos_secundarios && ejercicio.musculos_secundarios.length > 0" class="secondary-muscles">
          <small>Músculos secundarios:</small>
          <div class="muscle-tags">
            <ion-chip *ngFor="let musculo of ejercicio.musculos_secundarios" outline="true" class="muscle-chip">
              {{ musculo }}
            </ion-chip>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  </div>
  <!-- FIN TAB DE EJERCICIOS -->

  <!-- ============================================ -->
  <!-- TAB DE RUTINAS -->
  <!-- ============================================ -->
  <div *ngIf="segmentValue === 'rutinas'">
    <div class="filters-section">
      <h2 style="color: var(--primary-green); text-align: center; margin-bottom: 20px;">
        Rutinas de Entrenamiento
      </h2>

      <!-- Filtros -->
      <div class="filters-row">
        <ion-searchbar
          [(ngModel)]="filtroTextoRutina"
          (ionInput)="aplicarFiltrosRutinas()"
          placeholder="Buscar rutina..."
          [debounce]="300">
        </ion-searchbar>

        <ion-select
          [(ngModel)]="filtroNivelRutina"
          (ionChange)="aplicarFiltrosRutinas()"
          placeholder="Nivel"
          interface="popover">
          <ion-select-option value="">Todos los niveles</ion-select-option>
          <ion-select-option *ngFor="let nivel of nivesDificultad" [value]="nivel.value">
            {{ nivel.label }}
          </ion-select-option>
        </ion-select>
      </div>
    </div>

    <!-- Lista de rutinas -->
    <div *ngIf="loadingRutinas" style="text-align: center; padding: 40px;">
      <ion-spinner name="crescent"></ion-spinner>
      <p style="color: var(--ion-color-medium);">Cargando rutinas...</p>
    </div>

    <div *ngIf="!loadingRutinas && rutinasFiltradas.length === 0" style="text-align: center; padding: 40px;">
      <ion-icon name="barbell-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
      <p style="color: var(--ion-color-medium);">No hay rutinas creadas aún.</p>
      <p style="color: var(--ion-color-medium);">Presiona el botón + para crear una.</p>
    </div>

    <ion-card *ngFor="let rutina of rutinasFiltradas" class="rutina-card">
      <ion-card-header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <ion-card-title style="color: var(--primary-green);">{{ rutina.nombre }}</ion-card-title>
            <ion-card-subtitle>
              <ion-chip [color]="rutina.nivel_dificultad === 'principiante' ? 'success' : rutina.nivel_dificultad === 'intermedio' ? 'warning' : 'danger'">
                <ion-label>{{ rutina.nivel_dificultad }}</ion-label>
              </ion-chip>
              <span *ngIf="rutina.duracion_semanas">{{ rutina.duracion_semanas }} semanas</span>
            </ion-card-subtitle>
          </div>
          <div class="rutina-actions">
            <ion-button fill="clear" (click)="abrirModalRutina(rutina)">
              <ion-icon name="create" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="eliminarRutina(rutina)">
              <ion-icon name="trash" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <p *ngIf="rutina.descripcion" style="margin-bottom: 10px;">{{ rutina.descripcion }}</p>
        <p *ngIf="rutina.objetivo"><strong>Objetivo:</strong> {{ rutina.objetivo }}</p>

        <!-- Ejercicios de la rutina -->
        <div *ngIf="rutina.ejercicios && rutina.ejercicios.length > 0" style="margin-top: 15px;">
          <h4 style="color: var(--primary-green); margin-bottom: 10px;">
            Ejercicios ({{ rutina.ejercicios.length }})
          </h4>
          
          <div class="rutina-ejercicios-list">
            <div *ngFor="let ej of rutina.ejercicios; let i = index" class="rutina-ejercicio-item">
              <div class="ejercicio-info">
                <span class="ejercicio-numero">{{ i + 1 }}.</span>
                <div class="ejercicio-detalles">
                  <strong>{{ ej.ejercicio?.nombre }}</strong>
                  <div class="ejercicio-params">
                    <span>{{ ej.series }} series</span>
                    <span>{{ ej.repeticiones }} reps</span>
                    <span>{{ ej.descanso_segundos }}s descanso</span>
                  </div>
                </div>
              </div>
              
              <!-- Video del ejercicio -->
              <div *ngIf="ej.ejercicio?.enlace_video" class="ejercicio-video">
                <iframe
                  [src]="getSafeUrl(ej.ejercicio.enlace_video)"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  style="width: 100%; height: 200px; border-radius: 8px;">
                </iframe>
              </div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

</ion-content>

<!-- Modal para agregar/editar ejercicio -->
<ion-modal [isOpen]="showModal" (didDismiss)="cerrarModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ editMode ? 'Editar' : 'Nuevo' }} Ejercicio</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="modal-content">
      <form (ngSubmit)="guardarEjercicio()">
        
        <!-- Información básica -->
        <div class="form-section">
          <h4>Información básica</h4>
          
          <ion-item>
            <ion-label position="stacked">Nombre del ejercicio *</ion-label>
            <ion-input 
              [(ngModel)]="ejercicioActual.nombre" 
              name="nombre"
              placeholder="Ej: Press de banca"
              required>
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Descripción</ion-label>
            <ion-textarea 
              [(ngModel)]="ejercicioActual.descripcion" 
              name="descripcion"
              placeholder="Descripción breve del ejercicio"
              rows="3">
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Categoría *</ion-label>
            <ion-select [(ngModel)]="ejercicioActual.categoria" name="categoria" interface="popover">
              <ion-select-option *ngFor="let cat of categorias" [value]="cat.value">
                {{ cat.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Músculo principal *</ion-label>
            <ion-select [(ngModel)]="ejercicioActual.musculo_principal" name="musculo_principal" interface="popover">
              <ion-select-option *ngFor="let musculo of gruposMusculares" [value]="musculo">
                {{ musculo }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Nivel de dificultad *</ion-label>
            <ion-select [(ngModel)]="ejercicioActual.nivel_dificultad" name="nivel_dificultad" interface="popover">
              <ion-select-option *ngFor="let nivel of nivesDificultad" [value]="nivel.value">
                {{ nivel.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <!-- Video del ejercicio -->
        <div class="form-section">
          <h4>Video del ejercicio</h4>
          
          <ion-item>
            <ion-label position="stacked">URL de Google Drive *</ion-label>
            <ion-input 
              [(ngModel)]="ejercicioActual.enlace_video" 
              name="enlace_video"
              placeholder="https://drive.google.com/file/d/..."
              (ionBlur)="validarUrlDrive()"
              required>
            </ion-input>
          </ion-item>
          
          <div class="url-validation" *ngIf="ejercicioActual.enlace_video">
            <ion-item *ngIf="urlValida" lines="none" class="validation-success">
              <ion-icon name="checkmark-circle" slot="start" color="success"></ion-icon>
              <ion-label color="success">URL válida de Google Drive</ion-label>
            </ion-item>
            
            <ion-item *ngIf="!urlValida && ejercicioActual.enlace_video" lines="none" class="validation-error">
              <ion-icon name="close-circle" slot="start" color="danger"></ion-icon>
              <ion-label color="danger">URL no válida. Usa formato: drive.google.com/file/d/...</ion-label>
            </ion-item>
          </div>
          
          <ion-note>
            <strong>Requisitos:</strong><br>
            • Debe ser un enlace de Google Drive<br>
            • Solo videos o imágenes<br>
            • Videos: máximo 20 segundos<br>
            • Formato: https://drive.google.com/file/d/ID/view
          </ion-note>

          <!-- Preview del video si la URL es válida -->
          <div *ngIf="urlValida && ejercicioActual.enlace_video" class="video-preview">
            <ion-button 
              fill="outline" 
              size="small" 
              (click)="previsualizarVideo()"
              class="preview-button">
              <ion-icon name="play-circle" slot="start"></ion-icon>
              Vista previa del video
            </ion-button>
          </div>
        </div>

        <!-- Detalles adicionales -->
        <div class="form-section">
          <h4>Detalles adicionales</h4>
          
          <ion-item>
            <ion-label position="stacked">Duración (segundos) - Máximo 20</ion-label>
            <ion-input 
              [(ngModel)]="ejercicioActual.duracion_minutos" 
              name="duracion_minutos"
              type="number"
              min="1"
              max="20"
              placeholder="20"
              (ionInput)="convertirSegundosAMinutos()">
            </ion-input>
          </ion-item>
          
          <ion-note *ngIf="ejercicioActual.duracion_minutos">
            Duración: {{ ejercicioActual.duracion_minutos }} segundos 
            ({{ (ejercicioActual.duracion_minutos / 60).toFixed(2) }} minutos)
          </ion-note>

          <!-- Músculos secundarios -->
          <div class="array-section">
            <div class="array-header">
              <h5>Músculos secundarios</h5>
              <div class="header-actions">
                <ion-button 
                  *ngIf="ejercicioActual.musculos_secundarios.length > 0" 
                  size="small" 
                  fill="clear" 
                  color="warning"
                  (click)="limpiarMusculosSecundarios()">
                  <ion-icon name="trash-outline"></ion-icon>
                  <span>Limpiar</span>
                </ion-button>
                <ion-button size="small" fill="clear" (click)="agregarMusculoSecundario()">
                  <ion-icon name="add"></ion-icon>
                  <span>Agregar</span>
                </ion-button>
              </div>
            </div>
            
            <div class="dynamic-list">
              <div *ngFor="let musculo of ejercicioActual.musculos_secundarios; let i = index; trackBy: trackByIndex" class="dynamic-item">
                <ion-item>
                  <ion-label position="stacked">Músculo {{ i + 1 }}</ion-label>
                  <ion-select 
                    [(ngModel)]="ejercicioActual.musculos_secundarios[i]" 
                    [name]="'musculo_secundario_' + i"
                    placeholder="Seleccionar músculo"
                    interface="popover">
                    <ion-select-option *ngFor="let m of gruposMusculares" [value]="m">
                      {{ m }}
                    </ion-select-option>
                  </ion-select>
                  <ion-button 
                    slot="end" 
                    fill="clear" 
                    color="danger" 
                    (click)="eliminarMusculoSecundario(i)"
                    class="delete-item-btn">
                    <ion-icon name="close-circle"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
            </div>
            
            <ion-note *ngIf="ejercicioActual.musculos_secundarios.length === 0" class="empty-note">
              No hay músculos secundarios agregados
            </ion-note>
          </div>

          <!-- Equipamiento -->
          <div class="array-section">
            <div class="array-header">
              <h5>Equipamiento necesario</h5>
              <div class="header-actions">
                <ion-button 
                  *ngIf="ejercicioActual.equipamiento.length > 0" 
                  size="small" 
                  fill="clear" 
                  color="warning"
                  (click)="limpiarEquipamiento()">
                  <ion-icon name="trash-outline"></ion-icon>
                  <span>Limpiar</span>
                </ion-button>
                <ion-button size="small" fill="clear" (click)="agregarEquipamiento()">
                  <ion-icon name="add"></ion-icon>
                  <span>Agregar</span>
                </ion-button>
              </div>
            </div>
            
            <div class="dynamic-list">
              <div *ngFor="let equipo of ejercicioActual.equipamiento; let i = index; trackBy: trackByIndex" class="dynamic-item">
                <ion-item>
                  <ion-label position="stacked">Equipamiento {{ i + 1 }}</ion-label>
                  <ion-input 
                    [(ngModel)]="ejercicioActual.equipamiento[i]" 
                    [name]="'equipamiento_' + i"
                    placeholder="Ej: Mancuernas, Banca, Bandas elásticas..."
                    clear-input="true">
                  </ion-input>
                  <ion-button 
                    slot="end" 
                    fill="clear" 
                    color="danger" 
                    (click)="eliminarEquipamiento(i)"
                    class="delete-item-btn">
                    <ion-icon name="close-circle"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
            </div>
            
            <ion-note *ngIf="ejercicioActual.equipamiento.length === 0" class="empty-note">
              No hay equipamiento agregado. <span class="add-hint">Presiona + para agregar</span>
            </ion-note>
          </div>
        </div>

        <!-- Instrucciones -->
        <div class="form-section">
          <h4>Instrucciones y consejos</h4>
          
          <ion-item>
            <ion-label position="stacked">Instrucciones</ion-label>
            <ion-textarea 
              [(ngModel)]="ejercicioActual.instrucciones" 
              name="instrucciones"
              placeholder="Paso a paso del ejercicio..."
              rows="4">
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Consejos</ion-label>
            <ion-textarea 
              [(ngModel)]="ejercicioActual.consejos" 
              name="consejos"
              placeholder="Consejos para ejecutar correctamente..."
              rows="3">
            </ion-textarea>
          </ion-item>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <ion-button expand="block" type="submit" [disabled]="loading">
            <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
            <span *ngIf="!loading">{{ editMode ? 'Actualizar' : 'Crear' }} Ejercicio</span>
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal Rutina -->
<ion-modal [isOpen]="showModalRutina" (didDismiss)="cerrarModalRutina()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ editModeRutina ? 'Editar' : 'Nueva' }} Rutina</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalRutina()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="modal-content">
      <form (ngSubmit)="guardarRutina()">
        
        <!-- Información básica -->
        <div class="form-section">
          <h4>Información de la Rutina</h4>
          
          <ion-item>
            <ion-label position="stacked">Nombre de la rutina *</ion-label>
            <ion-input 
              [(ngModel)]="rutinaActual.nombre" 
              name="nombre"
              placeholder="Ej: Rutina de fuerza 4 semanas"
              required>
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Descripción</ion-label>
            <ion-textarea 
              [(ngModel)]="rutinaActual.descripcion" 
              name="descripcion"
              placeholder="Descripción breve de la rutina"
              rows="3">
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Objetivo</ion-label>
            <ion-input 
              [(ngModel)]="rutinaActual.objetivo" 
              name="objetivo"
              placeholder="Ej: Ganar masa muscular">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Duración (semanas)</ion-label>
            <ion-input 
              [(ngModel)]="rutinaActual.duracion_semanas" 
              name="duracion_semanas"
              type="number"
              min="1"
              placeholder="4">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Nivel de dificultad *</ion-label>
            <ion-select [(ngModel)]="rutinaActual.nivel_dificultad" name="nivel_dificultad" interface="popover">
              <ion-select-option *ngFor="let nivel of nivesDificultad" [value]="nivel.value">
                {{ nivel.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <!-- Ejercicios de la rutina -->
        <div class="form-section">
          <h4>Ejercicios de la Rutina</h4>
          
          <!-- Buscador de ejercicios -->
          <ion-searchbar
            [(ngModel)]="filtroEjercicioModal"
            (ionInput)="filtrarEjerciciosModal()"
            (ionChange)="filtrarEjerciciosModal()"
            placeholder="Buscar ejercicios por nombre, músculo o categoría..."
            [debounce]="200"
            animated="true"
            show-cancel-button="focus">
          </ion-searchbar>

          <!-- Lista de ejercicios disponibles -->
          <div class="ejercicios-busqueda">
            <!-- Cuando hay resultados -->
            <div *ngIf="ejerciciosDisponiblesFiltrados.length > 0">
              <ion-text color="medium" style="display: block; padding: 10px 16px; font-size: 0.9rem;">
                <ion-icon name="list-outline"></ion-icon>
                {{ ejerciciosDisponiblesFiltrados.length }} ejercicio(s) disponible(s)
                <span *ngIf="filtroEjercicioModal">(filtrado por "{{ filtroEjercicioModal }}")</span>
              </ion-text>
              
              <ion-list style="max-height: 300px; overflow-y: auto;">
                <ion-item 
                  *ngFor="let ej of ejerciciosDisponiblesFiltrados.slice(0, 20)" 
                  button 
                  (click)="agregarEjercicioARutina(ej)"
                  [disabled]="isEjercicioYaAgregado(ej.id)">
                  <ion-icon 
                    name="add-circle" 
                    slot="start" 
                    [color]="isEjercicioYaAgregado(ej.id) ? 'medium' : 'success'">
                  </ion-icon>
                  <ion-label>
                    <h3 [style.color]="isEjercicioYaAgregado(ej.id) ? 'var(--ion-color-medium)' : 'var(--primary-green)'">
                      {{ ej.nombre }}
                      <ion-badge *ngIf="isEjercicioYaAgregado(ej.id)" color="medium" style="margin-left: 8px; font-size: 0.7rem;">
                        Ya agregado
                      </ion-badge>
                    </h3>
                    <p style="color: var(--ion-color-medium);">
                      <ion-icon name="fitness-outline" style="font-size: 12px; vertical-align: middle;"></ion-icon>
                      {{ ej.musculo_principal }} • 
                      <ion-icon name="barbell-outline" style="font-size: 12px; vertical-align: middle;"></ion-icon>
                      {{ getCategoriaLabel(ej.categoria) }}
                    </p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>
            
            <!-- Cuando no hay resultados -->
            <ion-note *ngIf="ejerciciosDisponiblesFiltrados.length === 0 && ejerciciosDisponibles.length > 0" 
                      style="display: block; padding: 30px; text-align: center; color: var(--ion-color-medium);">
              <ion-icon name="sad-outline" style="font-size: 48px; margin-bottom: 10px; display: block;"></ion-icon>
              <p>No se encontraron ejercicios con "{{ filtroEjercicioModal }}"</p>
              <ion-button fill="clear" size="small" (click)="filtroEjercicioModal = ''; filtrarEjerciciosModal()">
                Limpiar búsqueda
              </ion-button>
            </ion-note>
            
            <!-- Cuando no hay ejercicios en la base de datos -->
            <ion-note *ngIf="ejerciciosDisponibles.length === 0" 
                      style="display: block; padding: 30px; text-align: center; color: var(--ion-color-warning);">
              <ion-icon name="alert-circle-outline" style="font-size: 48px; margin-bottom: 10px; display: block;"></ion-icon>
              <p>No hay ejercicios disponibles.</p>
              <p style="font-size: 0.9rem;">Crea ejercicios primero en la pestaña "Ejercicios"</p>
            </ion-note>
          </div>

          <!-- Ejercicios seleccionados -->
          <div style="margin-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 10px;">
              Ejercicios en la rutina ({{ ejerciciosSeleccionados.length }})
            </h4>
          </div>

          <div *ngIf="ejerciciosSeleccionados.length > 0" class="selected-exercises-list">
            <div *ngFor="let ejSel of ejerciciosSeleccionados; let i = index" class="exercise-item">
              <div class="exercise-header">
                <span class="order-number">{{ i + 1 }}</span>
                <strong style="color: var(--primary-green); flex: 1;">
                  {{ ejSel.ejercicio?.nombre || 'Nombre no disponible' }}
                </strong>
                <ion-button fill="clear" color="danger" size="small" (click)="eliminarEjercicioDeRutina(i)">
                  <ion-icon name="trash"></ion-icon>
                </ion-button>
              </div>
              
              <div class="exercise-params">
                <ion-item lines="none">
                  <ion-label position="stacked">Series</ion-label>
                  <ion-input 
                    [(ngModel)]="ejSel.series" 
                    [name]="'series_' + i"
                    type="number"
                    min="1"
                    placeholder="3">
                  </ion-input>
                </ion-item>

                <ion-item lines="none">
                  <ion-label position="stacked">Repeticiones</ion-label>
                  <ion-input 
                    [(ngModel)]="ejSel.repeticiones" 
                    [name]="'reps_' + i"
                    placeholder="10-12">
                  </ion-input>
                </ion-item>

                <ion-item lines="none">
                  <ion-label position="stacked">Descanso (seg)</ion-label>
                  <ion-input 
                    [(ngModel)]="ejSel.descanso_segundos" 
                    [name]="'descanso_' + i"
                    type="number"
                    placeholder="60">
                  </ion-input>
                </ion-item>
              </div>
            </div>
          </div>

          <ion-note *ngIf="ejerciciosSeleccionados.length === 0" class="empty-note">
            No hay ejercicios agregados. Selecciona ejercicios para agregar a la rutina.
          </ion-note>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <ion-button expand="block" type="submit" [disabled]="loadingRutinas">
            <ion-spinner *ngIf="loadingRutinas" name="crescent"></ion-spinner>
            <span *ngIf="!loadingRutinas">{{ editModeRutina ? 'Actualizar' : 'Crear' }} Rutina</span>
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
