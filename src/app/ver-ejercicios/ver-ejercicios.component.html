<ion-header [translucent]="true" class="custom-header">
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Entrenamientos</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="segmentValue === 'ejercicios'" (click)="abrirModal()">
        <ion-icon slot="start" name="add-circle-outline"></ion-icon>
        Nuevo Ejercicio
      </ion-button>
      <ion-button *ngIf="segmentValue === 'rutinas'" (click)="abrirModalRutina()">
        <ion-icon slot="start" name="add-circle-outline"></ion-icon>
        Nueva Rutina
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Spinner global para operaciones -->
  <div *ngIf="mostrarSpinnerGlobal" class="spinner-overlay-transparent">
    <app-spinner></app-spinner>
  </div>
  
  <!-- Spinner para eliminación de ejercicio -->
  <div *ngIf="eliminandoEjercicio" class="spinner-overlay-transparent">
    <app-spinner></app-spinner>
  </div>
  
  <!-- Segment para cambiar entre Ejercicios y Rutinas -->
  <ion-toolbar color="dark" class="segment-toolbar">
    <ion-segment [(ngModel)]="segmentValue" (ionChange)="onSegmentChange($event)" mode="md">
      <ion-segment-button value="ejercicios">
        <ion-label>Ejercicios</ion-label>
      </ion-segment-button>
      <ion-segment-button value="rutinas">
        <ion-label>Rutinas</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="main-content">
  
  <!-- ============================================ -->
  <!-- TAB DE EJERCICIOS -->
  <!-- ============================================ -->
  <div *ngIf="segmentValue === 'ejercicios'">
    
    <!-- Filtros -->
    <div class="filters-section">
    <ion-searchbar 
      [(ngModel)]="filtroTexto" 
      (ionInput)="aplicarFiltros()"
      placeholder="Buscar ejercicios..."
      show-clear-button="focus">
    </ion-searchbar>

    <div class="filter-row">
      <ion-select 
        [(ngModel)]="filtroCategoria" 
        (ionChange)="aplicarFiltros()"
        placeholder="Categoría"
        interface="popover">
        <ion-select-option value="">Todas las categorías</ion-select-option>
        <ion-select-option *ngFor="let cat of categorias" [value]="cat.value">
          {{ cat.label }}
        </ion-select-option>
      </ion-select>

      <ion-select 
        [(ngModel)]="filtroMusculo" 
        (ionChange)="aplicarFiltros()"
        placeholder="Músculo"
        interface="popover">
        <ion-select-option value="">Todos los músculos</ion-select-option>
        <ion-select-option *ngFor="let musculo of gruposMusculares" [value]="musculo">
          {{ musculo }}
        </ion-select-option>
      </ion-select>

      <ion-button fill="clear" (click)="limpiarFiltros()">
        <ion-icon name="refresh"></ion-icon>
      </ion-button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando ejercicios...</p>
  </div>

  <!-- Lista de ejercicios -->
  <div *ngIf="!loading" class="exercises-grid">
    
    <!-- Sin ejercicios -->
    <div *ngIf="ejerciciosFiltrados.length === 0" class="no-exercises">
      <ion-icon name="barbell-outline" size="large"></ion-icon>
      <h3>No hay ejercicios</h3>
      <p *ngIf="filtroTexto || filtroCategoria || filtroMusculo">
        No se encontraron ejercicios con estos filtros
      </p>
      <p *ngIf="!filtroTexto && !filtroCategoria && !filtroMusculo">
        Aún no has agregado ejercicios
      </p>
      <ion-button fill="outline" (click)="abrirModal()">
        Agregar primer ejercicio
      </ion-button>
    </div>

    <!-- Tarjetas de ejercicios -->
    <ion-card *ngFor="let ejercicio of ejerciciosFiltrados; trackBy: trackByIndex" class="exercise-card">
      
      <!-- Header de la tarjeta -->
      <ion-card-header>
        <div class="card-header-content">
          <div class="exercise-info">
            <ion-card-title>{{ ejercicio.nombre }}</ion-card-title>
            <ion-card-subtitle>
              <div class="subtitle-row">
                <ion-badge [color]="getCategoriaColor(ejercicio.categoria)" class="category-badge">
                  {{ getCategoriaLabel(ejercicio.categoria) }}
                </ion-badge>
                <ion-badge color="success" class="difficulty-badge">
                  {{ getNivelLabel(ejercicio.nivel_dificultad) }}
                </ion-badge>
              </div>
              <span class="muscle-group">
                <ion-icon name="body" size="small"></ion-icon>
                {{ ejercicio.musculo_principal }}
              </span>
            </ion-card-subtitle>
          </div>
          <div class="actions">
            <ion-button fill="clear" size="small" (click)="abrirModal(ejercicio)" class="action-btn edit-btn">
              <ion-icon slot="icon-only" name="pencil" style="font-size: 24px;"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small" (click)="eliminarEjercicio(ejercicio)" class="action-btn delete-btn" color="danger">
              <ion-icon slot="icon-only" name="trash" style="font-size: 24px;"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-card-header>

      <!-- Contenido de la tarjeta -->
      <ion-card-content>
        <p *ngIf="ejercicio.descripcion" class="description">
          {{ ejercicio.descripcion }}
        </p>
        
        <div class="exercise-details">
          <div *ngIf="ejercicio.equipamiento && ejercicio.equipamiento.length > 0" class="detail-item">
            <ion-icon name="barbell-outline"></ion-icon>
            <span>{{ getEquipamientoText(ejercicio.equipamiento) }}</span>
          </div>
        </div>

        <!-- Video/GIF embebido desde Google Drive -->
        <div *ngIf="ejercicio.enlace_video" class="video-container">
          <ng-container *ngIf="isImageUrl(ejercicio.enlace_video); else videoIframe">
            <img 
              [src]="getDirectImageUrl(ejercicio.enlace_video)" 
              alt="Ejercicio" 
              style="width:100%; height:auto; border-radius:8px; display:block;"
              (error)="onImageError($event, ejercicio.enlace_video)"
              (load)="onImageLoad(ejercicio.enlace_video)" />
          </ng-container>
          <ng-template #videoIframe>
            <ng-container *ngIf="isVideoUrl(ejercicio.enlace_video); else iframeFallback">
              <iframe [src]="getSafeUrl(getDirectVideoUrl(ejercicio.enlace_video))" 
                      frameborder="0" 
                      allowfullscreen
                      allow="autoplay"
                      loading="lazy"
                      style="width:100%; height:250px; border-radius:8px; border:2px solid rgba(0,255,136,0.3);">
              </iframe>
            </ng-container>
            <ng-template #iframeFallback>
              <iframe 
                [src]="getVideoEmbedUrl(ejercicio.enlace_video)" 
                frameborder="0" 
                allowfullscreen
                allow="autoplay"
                loading="lazy"
                class="exercise-video">
              </iframe>
            </ng-template>
          </ng-template>
        </div>

        <div *ngIf="ejercicio.musculos_secundarios && ejercicio.musculos_secundarios.length > 0" class="secondary-muscles">
          <small>Músculos secundarios:</small>
          <div class="muscle-tags">
            <ion-chip *ngFor="let musculo of ejercicio.musculos_secundarios" outline="true" class="muscle-chip">
              {{ musculo }}
            </ion-chip>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  </div>
  <!-- FIN TAB DE EJERCICIOS -->

  <!-- ============================================ -->
  <!-- TAB DE RUTINAS -->
  <!-- ============================================ -->
  <div *ngIf="segmentValue === 'rutinas'">
    <div class="filters-section">
      <!-- Filtros -->
      <div class="filters-row">
        <ion-searchbar
          [(ngModel)]="filtroTextoRutina"
          (ionInput)="aplicarFiltrosRutinas()"
          placeholder="Buscar rutina..."
          [debounce]="300">
        </ion-searchbar>

        <ion-select
          [(ngModel)]="filtroNivelRutina"
          (ionChange)="aplicarFiltrosRutinas()"
          placeholder="Nivel"
          interface="popover">
          <ion-select-option value="">Todos los niveles</ion-select-option>
          <ion-select-option *ngFor="let nivel of nivesDificultad" [value]="nivel.value">
            {{ nivel.label }}
          </ion-select-option>
        </ion-select>
      </div>
    </div>

    <!-- Lista de rutinas -->
    <div *ngIf="loadingRutinas" style="text-align: center; padding: 40px;">
      <ion-spinner name="crescent"></ion-spinner>
      <p style="color: var(--ion-color-medium);">Cargando rutinas...</p>
    </div>

    <div *ngIf="!loadingRutinas && rutinasFiltradas.length === 0" style="text-align: center; padding: 40px;">
      <ion-icon name="barbell-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
      <p style="color: var(--ion-color-medium);">No hay rutinas creadas aún.</p>
      <p style="color: var(--ion-color-medium);">Presiona el botón + para crear una.</p>
    </div>

    <ion-card *ngFor="let rutina of rutinasFiltradas" class="rutina-card">
      <ion-card-header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <ion-card-title style="color: var(--primary-green);">{{ rutina.nombre }}</ion-card-title>
            <ion-card-subtitle>
              <ion-chip [color]="rutina.nivel_dificultad === 'principiante' ? 'success' : rutina.nivel_dificultad === 'intermedio' ? 'warning' : 'danger'">
                <ion-label>{{ rutina.nivel_dificultad }}</ion-label>
              </ion-chip>
              <span *ngIf="rutina.duracion_semanas">{{ rutina.duracion_semanas }} semanas</span>
            </ion-card-subtitle>
          </div>
          <div class="rutina-actions">
            <ion-button fill="clear" (click)="abrirModalRutina(rutina)">
              <ion-icon name="create" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="eliminarRutina(rutina)">
              <ion-icon name="trash" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <p *ngIf="rutina.descripcion" style="margin-bottom: 10px; color: var(--ion-color-medium);">{{ rutina.descripcion }}</p>
        <p *ngIf="rutina.objetivo" style="color: var(--ion-color-medium);"><strong style="color: var(--primary-green);">Objetivo:</strong> {{ rutina.objetivo }}</p>

        <!-- Resumen de ejercicios -->
        <div *ngIf="rutina.ejercicios && rutina.ejercicios.length > 0" style="margin-top: 15px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <h4 style="color: var(--primary-green); margin: 0;">
              <ion-icon name="barbell-outline" style="vertical-align: middle;"></ion-icon>
              {{ rutina.ejercicios.length }} ejercicio(s)
            </h4>
          </div>
          
          <!-- Lista resumida (primeros 3) -->
          <ion-list style="background: transparent;">
            <ion-item *ngFor="let ej of rutina.ejercicios.slice(0, 3); let i = index" lines="none" style="--background: rgba(0, 255, 136, 0.05); margin-bottom: 5px; border-radius: 8px;">
              <ion-label>
                <h3 style="color: var(--primary-green); font-size: 0.95rem;">{{ i + 1 }}. {{ ej.ejercicio?.nombre }}</h3>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">
                  {{ ej.series }} series × {{ ej.repeticiones }} reps
                </p>
              </ion-label>
            </ion-item>
            
            <ion-note *ngIf="rutina.ejercicios.length > 3" style="display: block; text-align: center; color: var(--ion-color-medium); margin-top: 5px; font-size: 0.85rem;">
              + {{ rutina.ejercicios.length - 3 }} ejercicio(s) más...
            </ion-note>
          </ion-list>
        </div>

        <!-- Botones de acción -->
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <ion-button expand="block" fill="outline" (click)="verDetalleRutina(rutina)" style="flex: 1;">
            <ion-icon name="eye-outline" slot="start"></ion-icon>
            Ver más
          </ion-button>
          <ion-button expand="block" fill="solid" color="success" [routerLink]="['/asignar-rutina', rutina.id]" style="flex: 1;">
            <ion-icon name="person-add-outline" slot="start"></ion-icon>
            Asignar
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

</ion-content>

<!-- Modal para agregar/editar ejercicio -->
<ion-modal [isOpen]="showModal" (didDismiss)="cerrarModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ editMode ? 'Editar' : 'Nuevo' }} Ejercicio</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModal()">
            Volver
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <!-- Spinner dentro del modal -->
    <div *ngIf="mostrarSpinnerGlobal" class="spinner-overlay-transparent">
      <app-spinner></app-spinner>
    </div>

    <ion-content class="modal-content">
      <form (ngSubmit)="guardarEjercicio()">
        
        <!-- Información básica -->
        <div class="form-section">
          <h4>Información básica</h4>
          
          <ion-item>
            <ion-label position="stacked">Nombre del ejercicio *</ion-label>
            <ion-input 
              [(ngModel)]="ejercicioActual.nombre" 
              name="nombre"
              placeholder="Ej: Press de banca"
              required>
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Descripción</ion-label>
            <ion-textarea 
              [(ngModel)]="ejercicioActual.descripcion" 
              name="descripcion"
              placeholder="Descripción breve del ejercicio"
              rows="3">
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Categoría *</ion-label>
            <ion-select [(ngModel)]="ejercicioActual.categoria" name="categoria" interface="popover">
              <ion-select-option *ngFor="let cat of categorias" [value]="cat.value">
                {{ cat.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Músculo principal *</ion-label>
            <ion-select [(ngModel)]="ejercicioActual.musculo_principal" name="musculo_principal" interface="popover">
              <ion-select-option *ngFor="let musculo of gruposMusculares" [value]="musculo">
                {{ musculo }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Nivel de dificultad *</ion-label>
            <ion-select [(ngModel)]="ejercicioActual.nivel_dificultad" name="nivel_dificultad" interface="popover">
              <ion-select-option *ngFor="let nivel of nivesDificultad" [value]="nivel.value">
                {{ nivel.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <!-- Video del ejercicio -->
        <div class="form-section">
          <h4>Media del ejercicio (GIF o Video)</h4>
          
          <!-- Opción 1: Subir archivo -->
          <div class="upload-section" style="margin-bottom: 20px;">
            <ion-button expand="block" fill="outline" (click)="fileInput.click()">
              <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
              Subir GIF o Video
            </ion-button>
            <input 
              #fileInput
              type="file" 
              accept=".gif,video/mp4,video/quicktime,video/webm"
              (change)="onFileSelected($event)"
              style="display: none;">
          </div>

          <!-- Preview del archivo seleccionado -->
          <div *ngIf="archivoSeleccionado && previewUrl" class="file-preview" style="margin-bottom: 20px;">
            <ion-card>
              <ion-card-header>
                <ion-card-subtitle style="color: var(--ion-color-success);">
                  <ion-icon name="checkmark-circle"></ion-icon>
                  Archivo: {{ archivoSeleccionado.name }}
                </ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <img [src]="previewUrl" alt="Preview" style="width: 100%; border-radius: 8px;">
                <ion-button 
                  expand="block" 
                  fill="clear" 
                  color="danger" 
                  size="small"
                  (click)="archivoSeleccionado = null; previewUrl = null; fileInput.value = ''">
                  <ion-icon name="trash-outline" slot="start"></ion-icon>
                  Quitar archivo
                </ion-button>
              </ion-card-content>
            </ion-card>
          </div>

          <!-- Separador -->
          <div *ngIf="!archivoSeleccionado" style="text-align: center; margin: 20px 0; position: relative;">
            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.2);"></div>
            <span style="position: relative; background: var(--ion-background-color); padding: 0 10px; color: rgba(255,255,255,0.6);">o</span>
          </div>

          <!-- Opción 2: URL de Google Drive (solo si no hay archivo) -->
          <div *ngIf="!archivoSeleccionado">
            <ion-item>
              <ion-label position="stacked">URL de Google Drive</ion-label>
              <ion-input 
                [(ngModel)]="ejercicioActual.enlace_video" 
                name="enlace_video"
                placeholder="https://drive.google.com/file/d/..."
                (ionBlur)="validarUrlDrive()">
              </ion-input>
            </ion-item>
            
            <div class="url-validation" *ngIf="ejercicioActual.enlace_video">
              <ion-item *ngIf="urlValida" lines="none" class="validation-success">
                <ion-icon name="checkmark-circle" slot="start" color="success"></ion-icon>
                <ion-label color="success">URL válida de Google Drive</ion-label>
              </ion-item>
              
              <ion-item *ngIf="!urlValida && ejercicioActual.enlace_video" lines="none" class="validation-error">
                <ion-icon name="close-circle" slot="start" color="danger"></ion-icon>
                <ion-label color="danger">URL no válida. Usa formato: drive.google.com/file/d/...</ion-label>
              </ion-item>
            </div>
            
            <ion-note>
              <strong>Opción alternativa:</strong> Puedes usar una URL de Google Drive si prefieres no subir el archivo.
            </ion-note>

            <!-- Preview del video si la URL es válida -->
            <div *ngIf="urlValida && ejercicioActual.enlace_video" class="video-preview">
              <ion-button 
                fill="outline" 
                size="small" 
                (click)="previsualizarVideo()"
                class="preview-button">
                <ion-icon name="play-circle" slot="start"></ion-icon>
                Vista previa del video
              </ion-button>
            </div>
          </div>
        </div>

        <!-- Detalles adicionales -->
        <div class="form-section">
          <h4>Detalles adicionales</h4>
          
          <!-- Músculos secundarios -->
          <div class="array-section">
            <div class="array-header">
              <h5>Músculos secundarios</h5>
              <div class="header-actions">
                <ion-button 
                  *ngIf="ejercicioActual.musculos_secundarios.length > 0" 
                  size="small" 
                  fill="clear" 
                  color="warning"
                  (click)="limpiarMusculosSecundarios()">
                  <ion-icon name="trash-outline"></ion-icon>
                  <span>Limpiar</span>
                </ion-button>
                <ion-button size="small" fill="clear" (click)="agregarMusculoSecundario()">
                  <ion-icon name="add"></ion-icon>
                  <span>Agregar</span>
                </ion-button>
              </div>
            </div>
            
            <div class="dynamic-list">
              <div *ngFor="let musculo of ejercicioActual.musculos_secundarios; let i = index; trackBy: trackByIndex" class="dynamic-item">
                <ion-item>
                  <ion-label position="stacked">Músculo {{ i + 1 }}</ion-label>
                  <ion-select 
                    [(ngModel)]="ejercicioActual.musculos_secundarios[i]" 
                    [name]="'musculo_secundario_' + i"
                    placeholder="Seleccionar músculo"
                    interface="popover">
                    <ion-select-option *ngFor="let m of gruposMusculares" [value]="m">
                      {{ m }}
                    </ion-select-option>
                  </ion-select>
                  <ion-button 
                    slot="end" 
                    fill="clear" 
                    color="danger" 
                    (click)="eliminarMusculoSecundario(i)"
                    class="delete-item-btn">
                    <ion-icon name="close-circle"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
            </div>
            
            <ion-note *ngIf="ejercicioActual.musculos_secundarios.length === 0" class="empty-note">
              No hay músculos secundarios agregados
            </ion-note>
          </div>

          <!-- Equipamiento -->
          <div class="array-section">
            <div class="array-header">
              <h5>Equipamiento necesario</h5>
              <div class="header-actions">
                <ion-button 
                  *ngIf="ejercicioActual.equipamiento.length > 0" 
                  size="small" 
                  fill="clear" 
                  color="warning"
                  (click)="limpiarEquipamiento()">
                  <ion-icon name="trash-outline"></ion-icon>
                  <span>Limpiar</span>
                </ion-button>
                <ion-button size="small" fill="clear" (click)="agregarEquipamiento()">
                  <ion-icon name="add"></ion-icon>
                  <span>Agregar</span>
                </ion-button>
              </div>
            </div>
            
            <div class="dynamic-list">
              <div *ngFor="let equipo of ejercicioActual.equipamiento; let i = index; trackBy: trackByIndex" class="dynamic-item">
                <ion-item>
                  <ion-label position="stacked">Equipamiento {{ i + 1 }}</ion-label>
                  <ion-input 
                    [(ngModel)]="ejercicioActual.equipamiento[i]" 
                    [name]="'equipamiento_' + i"
                    placeholder="Ej: Mancuernas, Banca, Bandas elásticas..."
                    clear-input="true">
                  </ion-input>
                  <ion-button 
                    slot="end" 
                    fill="clear" 
                    color="danger" 
                    (click)="eliminarEquipamiento(i)"
                    class="delete-item-btn">
                    <ion-icon name="close-circle"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
            </div>
            
            <ion-note *ngIf="ejercicioActual.equipamiento.length === 0" class="empty-note">
              No hay equipamiento agregado. <span class="add-hint">Presiona + para agregar</span>
            </ion-note>
          </div>
        </div>

        <!-- Instrucciones -->
        <div class="form-section">
          <h4>Instrucciones y consejos</h4>
          
          <ion-item>
            <ion-label position="stacked">Instrucciones</ion-label>
            <ion-textarea 
              [(ngModel)]="ejercicioActual.instrucciones" 
              name="instrucciones"
              placeholder="Paso a paso del ejercicio..."
              rows="4">
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Consejos</ion-label>
            <ion-textarea 
              [(ngModel)]="ejercicioActual.consejos" 
              name="consejos"
              placeholder="Consejos para ejecutar correctamente..."
              rows="3">
            </ion-textarea>
          </ion-item>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <ion-button expand="block" type="submit">
            {{ editMode ? 'Actualizar' : 'Crear' }} Ejercicio
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal Rutina -->
<ion-modal [isOpen]="showModalRutina" (didDismiss)="cerrarModalRutina()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ editModeRutina ? 'Editar' : 'Nueva' }} Rutina</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalRutina()">
            Volver
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <!-- Spinner dentro del modal -->
    <div *ngIf="mostrarSpinnerGlobal" class="spinner-overlay-transparent">
      <app-spinner></app-spinner>
    </div>

    <ion-content class="modal-content">
      <form (ngSubmit)="guardarRutina()">
        
        <!-- Información básica -->
        <div class="form-section">
          <h4>Información de la Rutina</h4>
          
          <ion-item>
            <ion-label position="stacked">Nombre de la rutina *</ion-label>
            <ion-input 
              [(ngModel)]="rutinaActual.nombre" 
              name="nombre"
              placeholder="Ej: Rutina de fuerza 4 semanas"
              required>
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Descripción</ion-label>
            <ion-textarea 
              [(ngModel)]="rutinaActual.descripcion" 
              name="descripcion"
              placeholder="Descripción breve de la rutina"
              rows="3">
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Objetivo</ion-label>
            <ion-input 
              [(ngModel)]="rutinaActual.objetivo" 
              name="objetivo"
              placeholder="Ej: Ganar masa muscular">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Duración (semanas)</ion-label>
            <ion-input 
              [(ngModel)]="rutinaActual.duracion_semanas" 
              name="duracion_semanas"
              type="number"
              min="1"
              placeholder="4">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Nivel de dificultad *</ion-label>
            <ion-select [(ngModel)]="rutinaActual.nivel_dificultad" name="nivel_dificultad" interface="popover">
              <ion-select-option *ngFor="let nivel of nivesDificultad" [value]="nivel.value">
                {{ nivel.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <!-- Ejercicios de la rutina -->
        <div class="form-section">
          <h4>Ejercicios de la Rutina</h4>
          
          <!-- Buscador de ejercicios -->
          <ion-searchbar
            [(ngModel)]="filtroEjercicioModal"
            name="filtroEjercicioModal"
            (ionInput)="filtrarEjerciciosModal()"
            (ionChange)="filtrarEjerciciosModal()"
            placeholder="Buscar ejercicios por nombre, músculo o categoría..."
            [debounce]="200"
            animated="true"
            show-cancel-button="focus">
          </ion-searchbar>

          <!-- Lista de ejercicios disponibles -->
          <div class="ejercicios-busqueda">
            <!-- Cuando hay resultados -->
            <div *ngIf="ejerciciosDisponiblesFiltrados.length > 0">
              <ion-text color="medium" style="display: block; padding: 10px 16px; font-size: 0.9rem;">
                <ion-icon name="list-outline"></ion-icon>
                {{ ejerciciosDisponiblesFiltrados.length }} ejercicio(s) disponible(s)
                <span *ngIf="filtroEjercicioModal">(filtrado por "{{ filtroEjercicioModal }}")</span>
              </ion-text>
              
              <ion-list style="max-height: 300px; overflow-y: auto;">
                <ion-item 
                  *ngFor="let ej of ejerciciosDisponiblesFiltrados.slice(0, 20)" 
                  button 
                  (click)="agregarEjercicioARutina(ej)"
                  [disabled]="isEjercicioYaAgregado(ej.id)">
                  <ion-icon 
                    name="add-circle-outline" 
                    slot="start" 
                    [color]="isEjercicioYaAgregado(ej.id) ? 'medium' : 'success'">
                  </ion-icon>
                  <ion-label>
                    <h3 [style.color]="isEjercicioYaAgregado(ej.id) ? 'var(--ion-color-medium)' : 'var(--primary-green)'">
                      {{ ej.nombre }}
                      <ion-badge *ngIf="isEjercicioYaAgregado(ej.id)" color="success" style="margin-left: 8px; font-size: 0.7rem;">
                        Ya agregado
                      </ion-badge>
                    </h3>
                    <p style="color: var(--ion-color-medium);">
                      <ion-icon name="fitness-outline" style="font-size: 12px; vertical-align: middle;"></ion-icon>
                      {{ ej.musculo_principal }} • 
                      <ion-icon name="barbell-outline" style="font-size: 12px; vertical-align: middle;"></ion-icon>
                      {{ getCategoriaLabel(ej.categoria) }}
                    </p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>
            
            <!-- Cuando no hay resultados -->
            <ion-note *ngIf="ejerciciosDisponiblesFiltrados.length === 0 && ejerciciosDisponibles.length > 0" 
                      style="display: block; padding: 30px; text-align: center; color: var(--ion-color-medium);">
              <ion-icon name="sad-outline" style="font-size: 48px; margin-bottom: 10px; display: block;"></ion-icon>
              <p>No se encontraron ejercicios con "{{ filtroEjercicioModal }}"</p>
              <ion-button fill="clear" size="small" (click)="filtroEjercicioModal = ''; filtrarEjerciciosModal()">
                Limpiar búsqueda
              </ion-button>
            </ion-note>
            
            <!-- Cuando no hay ejercicios en la base de datos -->
            <ion-note *ngIf="ejerciciosDisponibles.length === 0" 
                      style="display: block; padding: 30px; text-align: center; color: var(--ion-color-warning);">
              <ion-icon name="alert-circle-outline" style="font-size: 48px; margin-bottom: 10px; display: block;"></ion-icon>
              <p>No hay ejercicios disponibles.</p>
              <p style="font-size: 0.9rem;">Crea ejercicios primero en la pestaña "Ejercicios"</p>
            </ion-note>
          </div>

          <!-- Ejercicios seleccionados -->
          <div style="margin-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 10px;">
              Ejercicios en la rutina ({{ ejerciciosSeleccionados.length }})
            </h4>
          </div>

          <div *ngIf="ejerciciosSeleccionados.length > 0" class="selected-exercises-list">
            <div *ngFor="let ejSel of ejerciciosSeleccionados; let i = index" class="exercise-item">
              <div class="exercise-header">
                <span class="order-number">{{ i + 1 }}</span>
                <strong style="color: var(--primary-green); flex: 1;">
                  {{ ejSel.ejercicio?.nombre || 'Nombre no disponible' }}
                </strong>
                
                <!-- Botones de reordenamiento -->
                <div class="reorder-buttons">
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    [disabled]="i === 0"
                    (click)="moverEjercicioArriba(i)" 
                    title="Mover arriba">
                    <ion-icon name="arrow-up" slot="icon-only"></ion-icon>
                  </ion-button>
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    [disabled]="i === ejerciciosSeleccionados.length - 1"
                    (click)="moverEjercicioAbajo(i)" 
                    title="Mover abajo">
                    <ion-icon name="arrow-down" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
                
                <ion-button fill="clear" color="danger" size="small" (click)="eliminarEjercicioDeRutina(i)" title="Eliminar ejercicio">
                  <ion-icon name="trash" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
              
              <div class="exercise-params">
                <ion-item lines="none">
                  <ion-label position="stacked">Series</ion-label>
                  <ion-input 
                    [(ngModel)]="ejSel.series" 
                    [name]="'series_' + i"
                    type="number"
                    min="1"
                    max="5"
                    placeholder="3"
                    (ionInput)="validarNumeroPositivo(ejSel, 'series')">
                  </ion-input>
                </ion-item>

                <ion-item lines="none">
                  <ion-label position="stacked">Repeticiones</ion-label>
                  <ion-input 
                    [(ngModel)]="ejSel.repeticiones" 
                    [name]="'reps_' + i"
                    placeholder="10-12">
                  </ion-input>
                </ion-item>

                <ion-item lines="none">
                  <ion-label position="stacked">Descanso (seg)</ion-label>
                  <ion-input 
                    [(ngModel)]="ejSel.descanso_segundos" 
                    [name]="'descanso_' + i"
                    type="number"
                    min="0"
                    placeholder="60"
                    (ionInput)="validarNumeroPositivo(ejSel, 'descanso_segundos')">
                  </ion-input>
                </ion-item>

                <ion-item lines="none">
                  <ion-label position="stacked">Porcentaje de fuerza</ion-label>
                  <ion-input 
                    [(ngModel)]="ejSel.porcentaje_fuerza" 
                    [name]="'porcentaje_' + i"
                    type="number"
                    min="0"
                    max="100"
                    placeholder="100"
                    (ionInput)="validarPorcentajeFuerza(ejSel)">
                  </ion-input>
                  <ion-note slot="helper">Porcentaje de fuerza requerido (0-100%)</ion-note>
                </ion-item>
              </div>
            </div>
          </div>

          <ion-note *ngIf="ejerciciosSeleccionados.length === 0" class="empty-note">
            No hay ejercicios agregados. Selecciona ejercicios para agregar a la rutina.
          </ion-note>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <ion-button expand="block" type="submit">
            {{ editModeRutina ? 'Actualizar' : 'Crear' }} Rutina
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para ver detalle completo de rutina -->
<ion-modal [isOpen]="showModalDetalle" (didDismiss)="cerrarModalDetalle()" class="modal-detalle-rutina">
  <ng-template>
    <ion-header>
      <ion-toolbar color="dark">
        <ion-buttons slot="end">
          <ion-button *ngIf="rutinaDetalle" (click)="abrirModalRutina(rutinaDetalle); cerrarModalDetalle()" fill="outline" style="--color: #00ff88; --border-color: #00ff88; margin-right: 8px;">
            <ion-icon slot="start" name="create-outline"></ion-icon>
            Editar
          </ion-button>
          <ion-button *ngIf="rutinaDetalle" [routerLink]="['/asignar-rutina', rutinaDetalle.id]" (click)="cerrarModalDetalle()" fill="solid" color="success" style="margin-right: 8px;">
            <ion-icon slot="start" name="person-add-outline"></ion-icon>
            Asignar
          </ion-button>
          <ion-button (click)="cerrarModalDetalle()" style="color: #00ff88; font-weight: 600;">
            Volver
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding" style="--background: #000000; background: #000000;">
      <div *ngIf="rutinaDetalle" class="detalle-rutina-container">
        <!-- Información general -->
        <div class="detalle-header">
          <h2 style="color: #00ff88; margin-bottom: 10px; margin-top: 0;">{{ rutinaDetalle.nombre }}</h2>
          
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <ion-chip [color]="rutinaDetalle.nivel_dificultad === 'principiante' ? 'success' : rutinaDetalle.nivel_dificultad === 'intermedio' ? 'warning' : 'danger'" style="font-weight: 600;">
              <ion-icon name="fitness-outline"></ion-icon>
              <ion-label>{{ getNivelLabel(rutinaDetalle.nivel_dificultad) }}</ion-label>
            </ion-chip>
            
            <ion-chip color="success" *ngIf="rutinaDetalle.duracion_semanas" style="font-weight: 600;">
              <ion-icon name="calendar-outline"></ion-icon>
              <ion-label>{{ rutinaDetalle.duracion_semanas }} semanas</ion-label>
            </ion-chip>
            
            <ion-chip color="success" *ngIf="rutinaDetalle.ejercicios?.length" style="font-weight: 600;">
              <ion-icon name="barbell-outline"></ion-icon>
              <ion-label>{{ rutinaDetalle.ejercicios?.length }} ejercicios</ion-label>
            </ion-chip>
          </div>

          <ion-card *ngIf="rutinaDetalle.descripcion" style="background: rgba(0, 255, 136, 0.1) !important; border: 2px solid rgba(0, 255, 136, 0.4); margin: 10px 0;">
            <ion-card-header style="padding-bottom: 10px;">
              <ion-card-title style="font-size: 1.1rem; color: #00ff88 !important; font-weight: 600;">
                <ion-icon name="document-text-outline" style="vertical-align: middle;"></ion-icon> Descripción
              </ion-card-title>
            </ion-card-header>
            <ion-card-content style="color: #ffffff !important; line-height: 1.6; font-size: 0.95rem;">
              {{ rutinaDetalle.descripcion }}
            </ion-card-content>
          </ion-card>

          <ion-card *ngIf="rutinaDetalle.objetivo" style="background: rgba(0, 255, 136, 0.1) !important; border: 2px solid rgba(0, 255, 136, 0.4); margin: 10px 0;">
            <ion-card-header style="padding-bottom: 10px;">
              <ion-card-title style="font-size: 1.1rem; color: #00ff88 !important; font-weight: 600;">
                <ion-icon name="trophy-outline" style="vertical-align: middle;"></ion-icon> Objetivo
              </ion-card-title>
            </ion-card-header>
            <ion-card-content style="color: #ffffff !important; line-height: 1.6; font-size: 0.95rem;">
              {{ rutinaDetalle.objetivo }}
            </ion-card-content>
          </ion-card>
        </div>

        <!-- Lista completa de ejercicios con videos -->
        <div class="ejercicios-detalle" style="margin-top: 20px;">
          <h3 style="color: #00ff88; margin-bottom: 15px; font-size: 1.3rem;">
            <ion-icon name="list-outline" style="vertical-align: middle;"></ion-icon>
            Ejercicios de la rutina
          </h3>

          <div *ngIf="rutinaDetalle.ejercicios && rutinaDetalle.ejercicios.length > 0" class="rutina-ejercicios-list">
            <ion-card *ngFor="let ej of rutinaDetalle.ejercicios; let i = index" 
                      style="background: rgba(0, 255, 136, 0.1) !important; border: 2px solid rgba(0, 255, 136, 0.4); margin-bottom: 20px;">
              <ion-card-header style="border-bottom: 2px solid rgba(0, 255, 136, 0.3); padding: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="background: #00ff88; color: #000000; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.3rem; flex-shrink: 0;">
                    {{ i + 1 }}
                  </div>
                  <div style="flex: 1;">
                    <ion-card-title style="color: #00ff88 !important; font-size: 1.2rem; margin: 0; font-weight: 700;">
                      {{ ej.ejercicio?.nombre || 'Ejercicio sin nombre' }}
                    </ion-card-title>
                    <ion-card-subtitle style="color: #cccccc !important; margin-top: 5px; font-size: 0.9rem;">
                      <ion-icon name="body-outline" style="vertical-align: middle;"></ion-icon>
                      {{ ej.ejercicio?.musculo_principal || 'N/A' }}
                    </ion-card-subtitle>
                  </div>
                </div>
              </ion-card-header>

              <ion-card-content style="padding: 20px; color: #ffffff !important;">
                <!-- Parámetros del ejercicio -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px;">
                  <div style="display: flex; align-items: center; gap: 10px; padding: 14px; background: rgba(0, 255, 136, 0.15); border: 1px solid rgba(0, 255, 136, 0.4); border-radius: 10px;">
                    <ion-icon name="repeat-outline" style="color: #00ff88; font-size: 32px;"></ion-icon>
                    <div>
                      <div style="font-size: 0.75rem; color: #cccccc; margin-bottom: 3px;">Series</div>
                      <div style="font-weight: bold; color: #00ff88; font-size: 1.1rem;">{{ ej.series || 'N/A' }}</div>
                    </div>
                  </div>
                  
                  <div style="display: flex; align-items: center; gap: 10px; padding: 14px; background: rgba(0, 255, 136, 0.15); border: 1px solid rgba(0, 255, 136, 0.4); border-radius: 10px;">
                    <ion-icon name="fitness-outline" style="color: #00ff88; font-size: 32px;"></ion-icon>
                    <div>
                      <div style="font-size: 0.75rem; color: #cccccc; margin-bottom: 3px;">Repeticiones</div>
                      <div style="font-weight: bold; color: #00ff88; font-size: 1.1rem;">{{ ej.repeticiones || 'N/A' }}</div>
                    </div>
                  </div>
                  
                  <div style="display: flex; align-items: center; gap: 10px; padding: 14px; background: rgba(0, 255, 136, 0.15); border: 1px solid rgba(0, 255, 136, 0.4); border-radius: 10px;">
                    <ion-icon name="time-outline" style="color: #00ff88; font-size: 32px;"></ion-icon>
                    <div>
                      <div style="font-size: 0.75rem; color: #cccccc; margin-bottom: 3px;">Descanso</div>
                      <div style="font-weight: bold; color: #00ff88; font-size: 1.1rem;">{{ ej.descanso_segundos || 60 }}s</div>
                    </div>
                  </div>

                  <div style="display: flex; align-items: center; gap: 10px; padding: 14px; background: rgba(0, 255, 136, 0.15); border: 1px solid rgba(0, 255, 136, 0.4); border-radius: 10px;">
                    <ion-icon name="speedometer-outline" style="color: #00ff88; font-size: 32px;"></ion-icon>
                    <div>
                      <div style="font-size: 0.75rem; color: #cccccc; margin-bottom: 3px;">Intensidad</div>
                      <div style="font-weight: bold; color: #00ff88; font-size: 1.1rem;">{{ ej.porcentaje_fuerza || 100 }}%</div>
                    </div>
                  </div>
                </div>

                <!-- Notas del ejercicio -->
                <div *ngIf="ej.notas" style="margin: 15px 0; padding: 14px; background: rgba(0, 255, 136, 0.08); border-left: 4px solid #00ff88; border-radius: 6px; color: #ffffff;">
                  <ion-icon name="information-circle-outline" style="vertical-align: middle; color: #00ff88; font-size: 1.2rem;"></ion-icon>
                  <strong style="color: #00ff88;"> Nota:</strong> {{ ej.notas }}
                </div>

                <!-- Video del ejercicio -->
                <div *ngIf="ej.ejercicio?.enlace_video" style="margin-top: 20px;">
                  <div style="background: #000000; border: 2px solid rgba(0, 255, 136, 0.3); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 16px rgba(0, 255, 136, 0.2);">
                    <ng-container *ngIf="isImageUrl(ej.ejercicio.enlace_video); else mediaBlock">
                      <img [src]="getDirectImageUrl(ej.ejercicio.enlace_video)" alt="Ejercicio" style="width:100%; height:auto; display:block;" />
                    </ng-container>
                    <ng-template #mediaBlock>
                      <ng-container *ngIf="isVideoUrl(ej.ejercicio.enlace_video); else safeIframe">
                        <iframe [src]="getSafeUrl(getDirectVideoUrl(ej.ejercicio.enlace_video))" 
                                frameborder="0" 
                                allowfullscreen
                                allow="autoplay"
                                loading="lazy"
                                style="width:100%; height:300px; display:block;">
                        </iframe>
                      </ng-container>
                      <ng-template #safeIframe>
                        <iframe
                          [src]="getSafeUrl(ej.ejercicio.enlace_video)"
                          frameborder="0"
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                          allowfullscreen
                          style="width: 100%; height: 300px; display: block;">
                        </iframe>
                      </ng-template>
                    </ng-template>
                  </div>
                </div>

                <div *ngIf="!ej.ejercicio?.enlace_video" style="text-align: center; color: #999999; margin-top: 20px; padding: 30px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px dashed rgba(255, 255, 255, 0.2);">
                  <ion-icon name="videocam-off-outline" style="font-size: 48px; display: block; margin-bottom: 10px; color: #666666;"></ion-icon>
                  <div style="font-size: 0.9rem;">Sin video disponible</div>
                </div>
              </ion-card-content>
            </ion-card>
          </div>

          <ion-note *ngIf="!rutinaDetalle.ejercicios || rutinaDetalle.ejercicios.length === 0" 
                    style="display: block; text-align: center; padding: 40px; color: #999999; background: rgba(255, 255, 255, 0.03); border-radius: 12px; margin-top: 20px;">
            <ion-icon name="barbell-outline" style="font-size: 64px; margin-bottom: 15px; display: block; color: #666666;"></ion-icon>
            <div style="font-size: 1.1rem;">No hay ejercicios en esta rutina</div>
          </ion-note>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para ver video (lazy loading) -->
<ion-modal [isOpen]="showModalVideo" (didDismiss)="cerrarVideoModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="dark">
        <ion-title>{{ ejercicioVideo?.nombre }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarVideoModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="modal-content">
      <div class="video-modal-container" *ngIf="ejercicioVideo">
          <div class="video-wrapper">
            <ng-container *ngIf="isImageUrl(ejercicioVideo.enlace_video); else mediaModal">
              <img [src]="getDirectImageUrl(ejercicioVideo.enlace_video)" alt="Ejercicio" style="width:100%; height:auto; max-height:400px; display:block;" />
            </ng-container>
            <ng-template #mediaModal>
              <ng-container *ngIf="isVideoUrl(ejercicioVideo.enlace_video); else modalIframe">
                <iframe [src]="getSafeUrl(getDirectVideoUrl(ejercicioVideo.enlace_video))" 
                        frameborder="0" 
                        allowfullscreen
                        allow="autoplay"
                        loading="lazy"
                        style="width:100%; height:400px; display:block;" 
                        class="video-frame">
                </iframe>
              </ng-container>
              <ng-template #modalIframe>
                <iframe 
                  [src]="getVideoEmbedUrl(ejercicioVideo.enlace_video)" 
                  width="100%" 
                  height="400" 
                  frameborder="0" 
                  allowfullscreen
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  class="video-frame">
                </iframe>
              </ng-template>
            </ng-template>
          </div>
        
        <div class="video-info">
          <h3>{{ ejercicioVideo.nombre }}</h3>
          <p *ngIf="ejercicioVideo.descripcion">{{ ejercicioVideo.descripcion }}</p>
          
          <div class="info-grid">
            <div class="info-item">
              <ion-icon name="body-outline"></ion-icon>
              <span>{{ ejercicioVideo.musculo_principal }}</span>
            </div>
            <div class="info-item" *ngIf="ejercicioVideo.categoria">
              <ion-icon name="fitness-outline"></ion-icon>
              <span>{{ ejercicioVideo.categoria }}</span>
            </div>
            <div class="info-item" *ngIf="ejercicioVideo.nivel_dificultad">
              <ion-icon name="speedometer-outline"></ion-icon>
              <span>{{ ejercicioVideo.nivel_dificultad }}</span>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
